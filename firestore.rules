
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Helper functions
    function isSignedIn() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return request.auth.uid == userId;
    }

    // USERS collection
    // Users can only create their own user document.
    // Users can only read and update their own document.
    match /users/{userId} {
      allow read: if isSignedIn() && isOwner(userId);
      allow update: if isSignedIn() && isOwner(userId) && request.resource.data.role == resource.data.role; // Prevent role change
      
      // Allow create for any authenticated user, with strict validation
      allow create: if isSignedIn() && isOwner(userId)
                    && ('name' in request.resource.data && request.resource.data.name is string)
                    && ('email' in request.resource.data && request.resource.data.email is string)
                    && ('language' in request.resource.data && request.resource.data.language is string)
                    && ('school' in request.resource.data && request.resource.data.school is string)
                    && ('role' in request.resource.data)
                    && (
                      (request.resource.data.role == 'teacher' && 
                       'teacherCode' in request.resource.data && 
                       request.resource.data.teacherCode is string &&
                       request.resource.data.teacherCode.size() == 6) ||
                      (request.resource.data.role == 'student' &&
                       'grade' in request.resource.data && request.resource.data.grade is string &&
                       'teacherId' in request.resource.data && request.resource.data.teacherId is string)
                    );
    }
    
    // TEACHER CODES collection
    // This is a lookup collection to find a teacher by their code.
    // It should be secure and only allow specific creation.
    match /teacherCodes/{code} {
      allow read: if isSignedIn(); // Students need to read this to find their teacher
      
      // Allow creation only if the user is a teacher and the teacherId matches their UID.
      // This is the key rule to allow the atomic teacher signup transaction.
      allow create: if isSignedIn()
                    && request.resource.data.teacherId == request.auth.uid;
      
      // No updates or deletes to prevent tampering.
      allow update, delete: if false;
    }

    // CONTENT collection
    // Teachers can create/read/update/delete their own content.
    // Students can only read content that has been assigned to them.
    match /content/{contentId} {
      allow read: if isSignedIn() && 
                    (resource.data.teacherId == request.auth.uid || 
                     (request.auth.uid in resource.data.assignedStudentIds));
      allow write: if isSignedIn() && request.resource.data.teacherId == request.auth.uid;
    }

    // ASSIGNMENTS collection
    // Teachers create assignments.
    // Students read their own assignments.
    match /assignments/{assignmentId} {
        allow read: if isSignedIn() && 
                      (resource.data.studentId == request.auth.uid || resource.data.teacherId == request.auth.uid);
        allow create: if isSignedIn() && request.resource.data.teacherId == request.auth.uid;
        allow update, delete: if isSignedIn() && resource.data.teacherId == request.auth.uid;
    }
    
    // ASSESSMENTS collection
    // Teachers create assessments.
    // Students can read assessments assigned to them.
    match /assessments/{assessmentId} {
        allow read: if isSignedIn() && (request.auth.uid in resource.data.assignedStudentIds || resource.data.teacherId == request.auth.uid);
        allow create: if isSignedIn() && request.resource.data.teacherId == request.auth.uid;
        allow update, delete: if isSignedIn() && resource.data.teacherId == request.auth.uid;
    }

    // SUBMISSIONS collection
    // Students can create submissions for an assessment.
    // Teachers can read/update submissions for their assessments.
    match /submissions/{submissionId} {
        allow read: if isSignedIn() && (resource.data.studentId == request.auth.uid || resource.data.teacherId == request.auth.uid);
        allow create: if isSignedIn() && request.resource.data.studentId == request.auth.uid;
        allow update: if isSignedIn() && resource.data.teacherId == request.auth.uid; // Teacher provides feedback
        allow delete: if false;
    }
    
    // GAME_SESSIONS collection
    // Students create their game session results.
    // Teachers can read game session results for their students.
    match /game_sessions/{sessionId} {
       allow read: if isSignedIn() && (resource.data.studentId == request.auth.uid || resource.data.teacherId == request.auth.uid);
       allow create: if isSignedIn() && request.resource.data.studentId == request.auth.uid;
       allow update, delete: if false;
    }
  }
}
