rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Helper function to check if a user is a teacher
    function isTeacher(userId) {
      return get(/databases/$(database)/documents/users/$(userId)).data.role == 'teacher';
    }

    // Helper function to check if a user is the owner of a document
    function isOwner(userId) {
      return request.auth.uid == userId;
    }

    // Rules for the 'users' collection
    match /users/{userId} {
      // ANY authenticated user can CREATE their own user document during signup.
      // This is the entry point for creating a user profile.
      allow create: if request.auth.uid == userId
                    && ('name' in request.resource.data && request.resource.data.name is string)
                    && ('role' in request.resource.data && (request.resource.data.role == 'teacher' || request.resource.data.role == 'student'));

      // Users can only READ their own document.
      allow read: if isOwner(userId);
      
      // Users can only UPDATE their own document.
      // They cannot change their role after it has been set.
      allow update: if isOwner(userId)
                    && request.resource.data.role == resource.data.role;
                    
      // No one can delete user documents.
      allow delete: if false;
    }

    // Rules for the 'teacherCodes' collection
    match /teacherCodes/{code} {
      // A teacher can CREATE a new teacher code document.
      // The `teacherId` in the new document MUST match the UID of the person creating it.
      // We check the incoming request data, not existing data, which is key for transactions.
      allow create: if request.auth.uid == request.resource.data.teacherId
                    && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'teacher';

      // Anyone can READ a teacher code document to verify it exists.
      allow read: if true;

      // No one can update or delete teacher codes.
      allow update, delete: if false;
    }
    
    // Rules for the 'content' collection
    match /content/{contentId} {
        // A teacher can create content.
        allow create: if isTeacher(request.auth.uid);

        // A teacher can read/update/delete their own content.
        allow read, update, delete: if isTeacher(request.auth.uid) && request.auth.uid == resource.data.teacherId;

        // A student can read content if their ID is in the 'assignedStudentIds' array.
        // This is important for when they open a lesson or assignment.
        match /content/{contentId} {
            allow read: if request.auth.uid in resource.data.assignedStudentIds;
        }
    }

    // Rules for 'assignments'
    // These link content to a specific student.
    match /assignments/{assignmentId} {
        // A teacher can create an assignment (assign content).
        allow create: if isTeacher(request.auth.uid) && request.auth.uid == request.resource.data.teacherId;
      
        // A student can read their own assignments.
        allow read: if request.auth.uid == resource.data.studentId;

        // A teacher can read assignments they created.
        allow list: if isTeacher(request.auth.uid) && request.query.where.teacherId == request.auth.uid;
        
        allow update, delete: if isTeacher(request.auth.uid) && request.auth.uid == resource.data.teacherId;
    }

    // Rules for 'submissions'
    // This is where students submit their work.
    match /submissions/{submissionId} {
        // A student can create a submission for an assignment.
        allow create: if request.auth.uid == request.resource.data.studentId;
      
        // The assigned teacher can read/update/delete submissions.
        allow read, update, delete: if isTeacher(request.auth.uid) && request.auth.uid == resource.data.teacherId;
    }

    // Rules for 'assessments'
    // These are the reading passages teachers create.
    match /assessments/{assessmentId} {
        // A teacher can create an assessment.
        allow create: if isTeacher(request.auth.uid) && request.auth.uid == request.resource.data.teacherId;

        // The teacher who created it can read/update/delete it.
        allow read, update, delete: if isTeacher(request.auth.uid) && request.auth.uid == resource.data.teacherId;

        // A student can read an assessment if their ID is in the assigned list.
        match /assessments/{assessmentId} {
            allow read: if request.auth.uid in resource.data.assignedStudentIds;
        }
    }
  }
}
