
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // ======== HELPER FUNCTIONS ========
    function isAuth() {
      return request.auth != null;
    }
    
    function isOwner(userId) {
      return isAuth() && request.auth.uid == userId;
    }
    
    // Check if the requesting user has the 'teacher' role in their user document.
    function isTeacher() {
      return isAuth() && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'teacher';
    }
    
    // Check if the requesting user has the 'student' role in their user document.
    function isStudent() {
      return isAuth() && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'student';
    }
    
    // ======== USER PROFILES ========
    match /users/{userId} {
      // READ: A user can read their own profile. A student can read their teacher's profile.
      // A teacher can read the profiles of students assigned to them.
      allow read: if isAuth() && (
        isOwner(userId) ||
        (isStudent() && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.teacherId == userId) ||
        (isTeacher() && get(/databases/$(database)/documents/users/$(userId)).data.teacherId == request.auth.uid)
      );
      
      // UPDATE: A user can only update their own profile.
      allow update: if isOwner(userId);
      
      // CREATE: A user can only create their own user document upon signup.
      allow create: if isOwner(userId) && 'role' in request.resource.data;
    }
    
    // ======== TEACHER CODES ========
    match /teacherCodes/{code} {
      // GET: Allow anyone to check if a code exists. This is required for student signup.
      allow get: if true;
      // LIST: Prevent anyone from listing all teacher codes.
      allow list: if false;
      
      // WRITE: Only a teacher creating their account can write to this collection,
      // enforced via a transaction in the client code.
      allow write: if isAuth() && request.auth.uid == request.resource.data.teacherId;
    }
    
    // ======== CONTENT (Stories, Worksheets, Visuals, Games) ========
    match /content/{contentId} {
        // A teacher can manage their own content.
        allow read, write, delete: if isTeacher() && get(/databases/$(database)/documents/content/$(contentId)).data.teacherId == request.auth.uid;
        
        // A student can read content if it has been assigned to them.
        allow read: if isStudent() && request.auth.uid in get(/databases/$(database)/documents/content/$(contentId)).data.assignedStudentIds;
    }
    
    // ======== ASSIGNMENTS ========
    match /assignments/{assignmentId} {
        // Teachers can create assignments.
        allow create: if isTeacher();
        
        // READ: Teacher can read assignments they created. Student can read assignments for them.
        allow read: if isAuth() && (
            get(/databases/$(database)/documents/assignments/$(assignmentId)).data.teacherId == request.auth.uid ||
            get(/databases/$(database)/documents/assignments/$(assignmentId)).data.studentId == request.auth.uid
        );

        // Nobody can update/delete assignments for now to maintain record integrity.
        allow update, delete: if false;
    }

    // ======== SUBMISSIONS & SESSIONS ========
    match /submissions/{submissionId} {
      // Student can create a submission.
      allow create: if isStudent() && request.resource.data.studentId == request.auth.uid;
      
      // READ: Student can read their own submission. Teacher can read their students' submissions.
      allow read: if isAuth() && (
        get(/databases/$(database)/documents/submissions/$(submissionId)).data.studentId == request.auth.uid ||
        get(/databases/$(database)/documents/submissions/$(submissionId)).data.teacherId == request.auth.uid
      );

      // Teacher can update a submission with feedback.
      allow update: if isTeacher() && get(/databases/$(database)/documents/submissions/$(submissionId)).data.teacherId == request.auth.uid;
    }

    match /game_sessions/{sessionId} {
       // Student can create a game session.
      allow create: if isStudent() && request.resource.data.studentId == request.auth.uid;

      // Teacher can read their students' game sessions.
      allow read: if isTeacher() && get(/databases/$(database)/documents/game_sessions/$(sessionId)).data.teacherId == request.auth.uid;
    }
  }
}
