
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // HELPER FUNCTIONS
    function getUserData(userId) {
      return get(/databases/$(database)/documents/users/$(userId)).data;
    }

    function isRole(userId, role) {
      return getUserData(userId).role == role;
    }

    function isTeacher(userId) {
      return isRole(userId, 'teacher');
    }

    function isStudent(userId) {
      return isRole(userId, 'student');
    }

    // Is the currently authenticated user the teacher of the student being accessed?
    function isMyStudent(studentId) {
      return isTeacher(request.auth.uid) && getUserData(studentId).teacherId == request.auth.uid;
    }
    
    // Is the user being accessed the teacher of the currently authenticated student?
    function isMyTeacher(teacherId) {
        return isStudent(request.auth.uid) && getUserData(request.auth.uid).teacherId == teacherId;
    }

    // RULES START HERE

    // `users` collection: Profiles for all users.
    match /users/{userId} {
      // A user can create their own profile record.
      allow create: if request.auth.uid == userId;
      
      // A user can read/update their own profile.
      // A teacher can read their student's profile.
      // A student can read their teacher's profile.
      allow read, update: if request.auth.uid == userId || isMyStudent(userId) || isMyTeacher(userId);
      
      // Teachers can list the users that are their students.
      // The client code MUST include `where("teacherId", "==", request.auth.uid)`
      allow list: if isTeacher(request.auth.uid);
    }

    // `teacherCodes` collection: Used to link students to teachers on sign-up.
    match /teacherCodes/{code} {
      // Any authenticated user can check if a code exists.
      allow get: if request.auth != null;
      // Only a teacher can create their own code.
      allow create: if isTeacher(request.resource.data.teacherId) && request.resource.data.teacherId == request.auth.uid;
    }

    // `content` collection: All teacher-created materials.
    match /content/{contentId} {
      // Teachers can manage their own content.
      allow create: if isTeacher(request.auth.uid) && request.resource.data.teacherId == request.auth.uid;
      allow update, delete: if isTeacher(request.auth.uid) && resource.data.teacherId == request.auth.uid;

      // Teachers can list their own content.
      // The client code MUST include `where("teacherId", "==", request.auth.uid)`
      allow list: if isTeacher(request.auth.uid);

      // A teacher can read their own content.
      // A student can read content that has been assigned to them.
      allow read: if (resource.data.teacherId == request.auth.uid) || 
                   (('assignedStudentIds' in resource.data) && request.auth.uid in resource.data.assignedStudentIds);
    }

    // `assignments` collection: Links content to a student.
    match /assignments/{assignmentId} {
      // A teacher can assign content.
      allow create: if isTeacher(request.auth.uid) && request.resource.data.teacherId == request.auth.uid;
      
      // Students can read/list assignments given to them.
      // The client code MUST include `where("studentId", "==", request.auth.uid)`
      allow read, list: if isStudent(request.auth.uid);
    }
    
    // `assessments` collection: Reading passages for students to take.
    match /assessments/{assessmentId} {
      // Teachers create assessments.
      allow create: if isTeacher(request.auth.uid) && request.resource.data.teacherId == request.auth.uid;
      
      // A teacher can read their own assessment.
      // A student can read an assessment assigned to them.
      allow read: if (resource.data.teacherId == request.auth.uid) || 
                   (request.auth.uid in resource.data.assignedStudentIds);
                   
      // Students can query for assessments assigned to them using 'array-contains'.
      // Teachers can list their own assessments.
      // The client code MUST include the appropriate where clause.
      allow list: if isStudent(request.auth.uid) || isTeacher(request.auth.uid);
    }

    // `submissions` collection: Student work submitted for review.
    match /submissions/{submissionId} {
      // Students create their own submissions.
      allow create: if isStudent(request.auth.uid) && request.resource.data.studentId == request.auth.uid;

      // Teachers can read, list, and update submissions from their students.
      // The client code MUST include `where("teacherId", "==", request.auth.uid)`
      allow read, list, update: if isTeacher(request.auth.uid);
    }
    
    // `game_sessions` collection: Results from completed games.
    match /game_sessions/{sessionId} {
      // Students create their own game sessions.
      allow create: if isStudent(request.auth.uid) && request.resource.data.studentId == request.auth.uid;
      
      // Teachers can read/list sessions for their students.
      // The client code MUST include `where("teacherId", "==", request.auth.uid)`
      allow read, list: if isTeacher(request.auth.uid);
    }
  }
}
