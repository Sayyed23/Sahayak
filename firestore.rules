
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper functions
    function isSignedIn() {
      return request.auth != null;
    }

    function isTeacher() {
      return isSignedIn() && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'teacher';
    }

    function isStudent() {
      return isSignedIn() && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'student';
    }
    
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    // Collection: users
    match /users/{userId} {
      // CREATE: Anyone can create their own user document during signup.
      allow create: if isSignedIn() && isOwner(userId);
      
      // READ: 
      // 1. Users can read their own profile.
      // 2. Students can read their teacher's profile.
      // 3. Teachers can read their students' profiles.
      allow read: if isOwner(userId)
                  || (isStudent() && resource.data.role == 'teacher' && resource.data.teacherCode == get(/databases/$(database)/documents/users/$(request.auth.uid)).data.teacherCode)
                  || (isTeacher() && resource.data.role == 'student' && resource.data.teacherId == request.auth.uid);
                  
      // UPDATE: Users can update their own profile.
      allow update: if isOwner(userId);

      // DELETE: Not allowed.
      allow delete: if false;
    }
    
    // Collection: teacherCodes
    match /teacherCodes/{code} {
      // CREATE: Only authenticated teachers can create a code (done via signup transaction).
      allow create: if isTeacher();

      // READ: Only students can read to validate a code during signup.
      allow read: if isStudent() || isSignedIn();

      // UPDATE/DELETE: Not allowed.
      allow update, delete: if false;
    }
    
    // Collection: content
    match /content/{contentId} {
        // CREATE/UPDATE/DELETE: Only teachers can manage their own content.
        allow create, update, delete: if isTeacher() && request.resource.data.teacherId == request.auth.uid;
        
        // READ: 
        // 1. Teachers can read their own content.
        // 2. Students can read content IF their studentId is in the `assignedStudentIds` array.
        allow read: if (isTeacher() && get(/databases/$(database)/documents/content/$(contentId)).data.teacherId == request.auth.uid)
                    || (isStudent() && request.auth.uid in get(/databases/$(database)/documents/content/$(contentId)).data.assignedStudentIds);
    }

    // Collection: assignments
    match /assignments/{assignmentId} {
      // CREATE: Only teachers can create assignments.
      allow create: if isTeacher();
      
      // READ:
      // 1. Students can read assignments assigned to them.
      // 2. Teachers can read assignments they created.
      allow read: if (isStudent() && resource.data.studentId == request.auth.uid)
                  || (isTeacher() && resource.data.teacherId == request.auth.uid);
      
      // UPDATE/DELETE: Not allowed for now.
      allow update, delete: if false;
    }

    // Collection: submissions
    match /submissions/{submissionId} {
      // CREATE: Students can create submissions.
      allow create: if isStudent() && request.resource.data.studentId == request.auth.uid;
      
      // READ: 
      // 1. Students can read their own submissions.
      // 2. Teachers can read submissions from their students.
      allow read: if (isStudent() && resource.data.studentId == request.auth.uid)
                  || (isTeacher() && resource.data.teacherId == request.auth.uid);
                  
      // UPDATE: Teachers can update submissions (e.g., to add feedback).
      allow update: if isTeacher() && resource.data.teacherId == request.auth.uid;

      // DELETE: Not allowed.
      allow delete: if false;
    }

    // Collection: game_sessions
    match /game_sessions/{sessionId} {
      // CREATE: Students can create their own game sessions.
      allow create: if isStudent() && request.resource.data.studentId == request.auth.uid;

      // READ: Teachers can read game sessions of their students.
      allow read: if isTeacher() && resource.data.teacherId == request.auth.uid;

      // UPDATE/DELETE: Not allowed.
      allow update, delete: if false;
    }
  }
}
