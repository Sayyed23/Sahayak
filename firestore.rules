rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Helper functions
    function isSignedIn() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return request.auth.uid == userId;
    }
    
    function isRole(role) {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == role;
    }

    // Users Collection
    match /users/{userId} {
      // Users can only create their own user document.
      // We validate the structure of the document being created.
      allow create: if isSignedIn() && isOwner(userId) &&
                       request.resource.data.uid == userId &&
                       request.resource.data.name is string &&
                       request.resource.data.school is string &&
                       request.resource.data.language is string &&
                       (
                         ( // Teacher Role Validation
                           request.resource.data.role == 'teacher' &&
                           request.resource.data.teacherCode is string &&
                           !('grade' in request.resource.data) &&
                           !('teacherId' in request.resource.data)
                         ) ||
                         ( // Student Role Validation
                           request.resource.data.role == 'student' &&
                           request.resource.data.grade is string &&
                           request.resource.data.teacherId is string &&
                           !('teacherCode' in request.resource.data)
                         )
                       );

      // Users can read their own profile.
      // Teachers can read the profiles of their students.
      // Students can read the profile of their teacher.
      allow read: if isSignedIn() && 
                   (isOwner(userId) || 
                    (isRole('teacher') && get(/databases/$(database)/documents/users/$(userId)).data.teacherId == request.auth.uid) ||
                    (isRole('student') && resource.data.role == 'teacher' && resource.data.uid == get(/databases/$(database)/documents/users/$(request.auth.uid)).data.teacherId)
                   );

      // Users can only update their own profile fields.
      allow update: if isSignedIn() && isOwner(userId);

      // No user can delete another user's account.
      allow delete: if false;
    }

    // Teacher Codes Collection (for student signup lookup)
    match /teacherCodes/{code} {
      // Any signed-in user can read this during student signup to validate a code.
      allow read: if isSignedIn();

      // The user creating the code must be the one associated with it.
      // This rule works within a transaction because it checks incoming data,
      // not a pre-existing user document.
      allow create: if isSignedIn() && request.resource.data.teacherId == request.auth.uid;
      
      // Codes are immutable.
      allow update, delete: if false;
    }

    // Content Collection (stories, worksheets, etc.)
    match /content/{contentId} {
      // A teacher can create content.
      allow create: if isSignedIn() && isRole('teacher') && request.resource.data.teacherId == request.auth.uid;

      // Teachers can read/update/delete their own content.
      // Students can read content if their ID is in the `assignedStudentIds` array.
      allow read, update: if isSignedIn() && 
                         (isRole('teacher') && resource.data.teacherId == request.auth.uid);
      allow read: if isSignedIn() &&
                   (isRole('student') && request.auth.uid in resource.data.assignedStudentIds);

      allow delete: if isSignedIn() && isRole('teacher') && resource.data.teacherId == request.auth.uid;
    }

    // Assignments Collection
    match /assignments/{assignmentId} {
      // Teachers can create assignments for their students.
      allow create: if isSignedIn() && isRole('teacher') && request.resource.data.teacherId == request.auth.uid;
      
      // Teachers can view all their assignments.
      // Students can only view assignments given to them.
      allow read, list: if isSignedIn() && 
                         (isRole('teacher') && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.uid == resource.data.teacherId) ||
                         (isRole('student') && resource.data.studentId == request.auth.uid);

      allow update, delete: if isSignedIn() && isRole('teacher') && resource.data.teacherId == request.auth.uid;
    }

    // Submissions Collection (for assessments, worksheets)
    match /submissions/{submissionId} {
      // Students can create submissions for their assignments.
      allow create: if isSignedIn() && isRole('student') && request.resource.data.studentId == request.auth.uid;

      // Teachers can read submissions from their students.
      // Students can read their own submissions.
      allow read: if isSignedIn() && 
                   ((isRole('teacher') && resource.data.teacherId == request.auth.uid) ||
                    (isRole('student') && resource.data.studentId == request.auth.uid));

      // Teachers can update submissions to provide feedback.
      allow update: if isSignedIn() && isRole('teacher') && resource.data.teacherId == request.auth.uid;

      allow delete: if false;
    }

    // Assessments Collection (reading passages)
    match /assessments/{assessmentId} {
      // Teachers can create assessments.
      allow create: if isSignedIn() && isRole('teacher') && request.resource.data.teacherId == request.auth.uid;

      // Teachers can read their own assessments.
      // Students can read assessments assigned to them.
      allow read: if isSignedIn() &&
                   ((isRole('teacher') && resource.data.teacherId == request.auth.uid) ||
                    (isRole('student') && request.auth.uid in resource.data.assignedStudentIds));
      
      allow update, delete: if isSignedIn() && isRole('teacher') && resource.data.teacherId == request.auth.uid;
    }
    
    // Game Sessions Collection
    match /game_sessions/{sessionId} {
        allow create: if isSignedIn() && isRole('student') && request.resource.data.studentId == request.auth.uid;
        allow read: if isSignedIn() && 
                     ((isRole('teacher') && resource.data.teacherId == request.auth.uid) ||
                      (isRole('student') && resource.data.studentId == request.auth.uid));
        allow update, delete: if false;
    }
  }
}
