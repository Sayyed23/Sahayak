rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    match /users/{userId} {
      // Allow anyone to read user data. This is needed for unauthenticated
      // student sign-up to validate teacher codes.
      // For a production app, this should be more secure, likely using a Cloud Function.
      allow read: if true;
      
      // Allow users to create their own document upon signing up.
      allow create: if request.auth != null && request.auth.uid == userId;
      
      // Allow users to update their own document after logging in.
      allow update: if request.auth != null && request.auth.uid == userId;

      // Prevent deletion of user documents.
      allow delete: if false;
    }

    // Teachers can create and manage assessments. 
    // Assigned students can read them.
    match /assessments/{assessmentId} {
      allow read: if request.auth != null && (request.auth.uid == resource.data.teacherId || resource.data.assignedStudentIds.hasAny([request.auth.uid]));
      allow create: if request.auth != null; // Teachers create these
      allow update, delete: if request.auth != null && request.auth.uid == resource.data.teacherId;
    }

    // Students create submissions. 
    // The student who created it and their teacher can read/review it.
    match /submissions/{submissionId} {
      allow read: if request.auth != null && (request.auth.uid == resource.data.studentId || request.auth.uid == resource.data.teacherId);
      allow create: if request.auth != null && request.auth.uid == request.resource.data.studentId;
      allow update: if request.auth != null && request.auth.uid == resource.data.teacherId;
      allow delete: if false;
    }
  }
}
