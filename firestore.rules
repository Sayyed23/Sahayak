rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // HELPER FUNCTIONS
    function isSignedIn() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return request.auth.uid == userId;
    }

    function getUserData(userId) {
      return get(/databases/$(database)/documents/users/$(userId)).data;
    }

    function isTeacher() {
      return isSignedIn() && getUserData(request.auth.uid).role == 'teacher';
    }

    function isStudent() {
      return isSignedIn() && getUserData(request.auth.uid).role == 'student';
    }

    // RULE DEFINITIONS

    // Users can be created by anyone during signup.
    // Users can read/update their own profile.
    // Teachers can read the profiles of their students.
    // Students can read the profile of their teacher.
    match /users/{userId} {
      allow create: if request.auth.uid == userId;
      allow read: if isOwner(userId)
                  || (isTeacher() && getUserData(userId).teacherId == request.auth.uid)
                  || (isStudent() && getUserData(request.auth.uid).teacherId == userId);
      allow update: if isOwner(userId);
      allow list: if isTeacher(); // Allow teachers to list their students
    }

    // Teacher codes must be validated during student signup.
    // This requires unauthenticated read access.
    // A teacher's code can only be created by that teacher in a transaction.
    match /teacherCodes/{code} {
      allow read: if true; // Allows checking the code before signup
      allow create: if isTeacher() && request.resource.data.teacherId == request.auth.uid;
    }

    // Teachers can manage their own content.
    // Students can read content ONLY if they are assigned.
    match /content/{contentId} {
      allow read: if (isTeacher() && resource.data.teacherId == request.auth.uid)
                   || (isStudent() && request.auth.uid in resource.data.assignedStudentIds);
      allow create, update, delete: if isTeacher();
      allow list: if isTeacher();
    }

    // Teachers create assignments.
    // Students can only read/list their own assignments.
    match /assignments/{assignmentId} {
      allow read: if (isStudent() && resource.data.studentId == request.auth.uid) || isTeacher();
      allow list: if isSignedIn();
      allow create: if isTeacher();
    }

    // `assessments` are reading passage templates created by teachers.
    // Students can read an assessment if it's assigned to them.
    // Teachers can manage their own assessments.
    // The `list` rule allows students to query for their assignments on the dashboard.
    match /assessments/{assessmentId} {
      allow read: if (isStudent() && request.auth.uid in resource.data.assignedStudentIds)
                   || (isTeacher() && resource.data.teacherId == request.auth.uid);
      allow create, update, delete: if isTeacher();
      allow list: if isSignedIn();
    }

    // Students create submissions.
    // Teachers can read/update submissions for their students.
    // Students can read their own submissions.
    match /submissions/{submissionId} {
      allow create: if isStudent() && request.resource.data.studentId == request.auth.uid;
      allow read, update: if (isTeacher() && resource.data.teacherId == request.auth.uid)
                           || (isStudent() && resource.data.studentId == request.auth.uid);
       allow list: if isSignedIn();
    }

    // Students create game sessions after playing.
    // Teachers can read their students' game sessions.
    match /game_sessions/{sessionId} {
      allow create: if isStudent() && request.resource.data.studentId == request.auth.uid;
      allow read: if isTeacher() && resource.data.teacherId == request.auth.uid;
    }
  }
}
