
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // By default, deny all reads and writes
    match /{document=**} {
      allow read, write: if false;
    }

    //----------------------------------------------------------------------
    //  USERS Collection
    //----------------------------------------------------------------------
    match /users/{userId} {
      // ANYONE can create a user document IF:
      // 1. They are creating their own document (UID matches).
      // 2. The role is either 'teacher' or 'student'.
      // 3. The request body contains all the required fields.
      allow create: if request.auth.uid == userId
                    && request.resource.data.role in ['teacher', 'student']
                    && 'name' in request.resource.data
                    && 'email' in request.resource.data
                    && 'school' in request.resource.data
                    && 'language' in request.resource.data
                    && (request.resource.data.role == 'teacher' ? 'teacherCode' in request.resource.data : 'grade' in request.resource.data && 'teacherId' in request.resource.data);

      // A USER can read their own document.
      // A STUDENT can read their teacher's document.
      // A TEACHER can read their own student's document.
      allow read: if request.auth.uid == userId 
                  || (exists(/databases/$(database)/documents/users/$(request.auth.uid)) && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'student' && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.teacherId == userId)
                  || (exists(/databases/$(database)/documents/users/$(request.auth.uid)) && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'teacher' && get(/databases/$(database)/documents/users/$(userId)).data.teacherId == request.auth.uid);

      // A USER can update their own document IF:
      // 1. They are only changing their name, school, or language.
      // 2. They are not trying to change their role, email, or other protected fields.
      allow update: if request.auth.uid == userId
                     && request.resource.data.keys().hasOnly(['name', 'school', 'grade', 'language'])
                     && request.resource.data.name is string
                     && request.resource.data.school is string;
    }

    //----------------------------------------------------------------------
    //  TEACHER CODES Collection
    //----------------------------------------------------------------------
    match /teacherCodes/{code} {
      // A TEACHER can create a teacher code document IF:
      // 1. The code does not already exist.
      // 2. The `teacherId` in the document matches their own UID.
      // 3. The user creating the code has the 'teacher' role.
      allow create: if request.auth.uid == request.resource.data.teacherId
                    && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'teacher';
    }

    //----------------------------------------------------------------------
    //  CONTENT Collection
    //----------------------------------------------------------------------
    match /content/{contentId} {
      // A TEACHER can create content.
      allow create: if get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'teacher' 
                     && request.resource.data.teacherId == request.auth.uid;
                     
      // A TEACHER can read their own content.
      // A STUDENT can read content if their ID is in the `assignedStudentIds` array.
      allow read: if get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'teacher' && resource.data.teacherId == request.auth.uid
                  || (get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'student' && request.auth.uid in resource.data.assignedStudentIds);

      // A TEACHER can update their own content.
      allow update: if get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'teacher' && resource.data.teacherId == request.auth.uid;

      // A TEACHER can delete their own content.
      allow delete: if get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'teacher' && resource.data.teacherId == request.auth.uid;
    }
    
    //----------------------------------------------------------------------
    //  ASSIGNMENTS Collection (links content to students)
    //----------------------------------------------------------------------
    match /assignments/{assignmentId} {
        // A TEACHER can create assignments for their students.
        allow create: if get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'teacher'
                       && request.resource.data.teacherId == request.auth.uid;

        // A STUDENT can read assignments assigned to them.
        // A TEACHER can read assignments they created.
        allow read: if (get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'student' && resource.data.studentId == request.auth.uid)
                    || (get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'teacher' && resource.data.teacherId == request.auth.uid);
    }
    
    //----------------------------------------------------------------------
    //  ASSESSMENTS Collection (Reading Passages)
    //----------------------------------------------------------------------
    match /assessments/{assessmentId} {
        // A TEACHER can create assessments.
        allow create: if get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'teacher'
                       && request.resource.data.teacherId == request.auth.uid;
                       
        // A STUDENT can read an assessment if their ID is in the `assignedStudentIds` array.
        // A TEACHER can read assessments they created.
        allow read: if (get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'student' && request.auth.uid in resource.data.assignedStudentIds)
                    || (get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'teacher' && resource.data.teacherId == request.auth.uid);
    }

    //----------------------------------------------------------------------
    //  SUBMISSIONS Collection
    //----------------------------------------------------------------------
    match /submissions/{submissionId} {
      // A STUDENT can create a submission for an assessment assigned to them.
      allow create: if get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'student'
                     && request.resource.data.studentId == request.auth.uid;

      // A TEACHER can read submissions from their students.
      // A STUDENT can read their own submissions.
      allow read: if (get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'teacher' && resource.data.teacherId == request.auth.uid)
                  || (get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'student' && resource.data.studentId == request.auth.uid);

      // A TEACHER can update a submission (to add feedback).
      allow update: if get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'teacher' 
                     && resource.data.teacherId == request.auth.uid;
    }
  }
}
