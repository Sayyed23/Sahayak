
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Helper function to check if the user's role is 'teacher'
    function isTeacher(userId) {
      return get(/databases/$(database)/documents/users/$(userId)).data.role == 'teacher';
    }

    // Users collection
    match /users/{userId} {
      allow read, update: if request.auth.uid == userId;
      // Anyone can create a user document for themselves during signup
      allow create: if request.auth.uid == request.resource.data.uid;
    }

    // Teacher codes are used for student signup.
    match /teacherCodes/{code} {
      // Anyone can read teacher codes to validate them during student signup.
      allow read: if true;
      // Only an authenticated user can create a code for themselves.
      // This is part of the teacher signup transaction.
      allow create: if request.auth.uid == request.resource.data.teacherId;
    }

    // Content collection (stories, worksheets, visuals, games)
    match /content/{contentId} {
      // Teachers can create, update, and delete their own content.
      allow create, update, delete: if isTeacher(request.auth.uid) && request.resource.data.teacherId == request.auth.uid;
      // Content can be read by the teacher who created it, or any student it's assigned to.
      allow read: if resource.data.teacherId == request.auth.uid ||
                     (resource.data.assignedStudentIds != null && request.auth.uid in resource.data.assignedStudentIds);
    }
    
    // Assessments are reading passages assigned by teachers.
    match /assessments/{assessmentId} {
        // Teachers create assessments.
        allow create: if isTeacher(request.auth.uid) && request.resource.data.teacherId == request.auth.uid;
        // The teacher who created it or a student it's assigned to can read it.
        allow read: if resource.data.teacherId == request.auth.uid ||
                       (resource.data.assignedStudentIds != null && request.auth.uid in resource.data.assignedStudentIds);
    }

    // Assignments link content to students.
    match /assignments/{assignmentId} {
        // Created by teachers.
        allow create: if isTeacher(request.auth.uid) && request.resource.data.teacherId == request.auth.uid;
        // Read by the assigned student or the teacher who assigned it.
        allow read: if request.auth.uid == resource.data.studentId ||
                       request.auth.uid == resource.data.teacherId;
    }

    // Submissions from students (reading recordings, worksheet images).
    match /submissions/{submissionId} {
      // Students can create their own submissions.
      allow create: if request.auth.uid == request.resource.data.studentId;
      // Submissions can be read by the student who created it, or their teacher.
      allow read: if request.auth.uid == resource.data.studentId || 
                     request.auth.uid == resource.data.teacherId;
      // Teachers can update submissions (e.g., to add feedback).
      allow update: if request.auth.uid == resource.data.teacherId;
    }
    
    // Game sessions track student game plays.
    match /game_sessions/{sessionId} {
      // Students create their own game sessions.
      allow create: if request.auth.uid == request.resource.data.studentId;
      // Read by the student who played or their teacher.
      allow read: if request.auth.uid == resource.data.studentId ||
                     request.auth.uid == resource.data.teacherId;
    }
  }
}
