
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    // By default, deny all reads and writes
    match /{document=**} {
      allow read, write: if false;
    }

    // Allow users to read and update their own user document.
    // Allow any user (authenticated or not) to query the users collection
    // to validate a teacher's code during student sign-up.
    match /users/{userId} {
      allow read: if true; 
      allow create: if request.auth != null && request.auth.uid == userId;
      allow update: if request.auth != null && request.auth.uid == userId;
      allow delete: if false;
    }

    // Teachers can create assessments.
    // Assigned students can read the assessment they need to take.
    match /assessments/{assessmentId} {
      allow read: if request.auth != null && (
                    resource.data.teacherId == request.auth.uid ||
                    request.auth.uid in resource.data.assignedStudentIds
                  );
      allow create: if request.auth != null; // Further checks can be added in security rules or backend
      allow update, delete: if request.auth != null && request.auth.uid == resource.data.teacherId;
    }

    // Students can create submissions for an assessment.
    // The teacher who assigned the assessment can read/update the submission.
    // The student who made the submission can read it.
    match /submissions/{submissionId} {
      allow read: if request.auth != null && (
                    request.auth.uid == resource.data.studentId || 
                    request.auth.uid == resource.data.teacherId
                  );
      allow create: if request.auth != null && request.auth.uid == request.resource.data.studentId;
      allow update: if request.auth != null && request.auth.uid == resource.data.teacherId;
      allow delete: if false;
    }
  }
}
