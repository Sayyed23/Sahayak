
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
  
    // Users can only read/write their own data, but some public data is readable by others.
    match /users/{userId} {
      allow read: if request.auth != null; // Allow any authenticated user to read profile data
      allow create: if request.auth.uid == userId; // Allow user to create their own profile on signup
      allow update: if request.auth.uid == userId; // Allow user to update their own profile
    }

    // Teachers can manage their own teacher code mapping. Students can read it for validation.
    match /teacherCodes/{code} {
      allow read: if request.auth != null;
      allow create: if request.auth.uid == request.resource.data.teacherId;
    }

    // Teachers can manage their content. Students can only read content assigned to them.
    match /content/{contentId} {
      allow read: if request.auth.uid == resource.data.teacherId || request.auth.uid in resource.data.assignedStudentIds;
      allow create, update, delete: if request.auth.uid == resource.data.teacherId;
    }

    // Teachers create assignments. Students can only read assignments given to them.
    match /assignments/{assignmentId} {
      allow read: if request.auth.uid == resource.data.teacherId || request.auth.uid == resource.data.studentId;
      allow create: if request.auth.uid == request.resource.data.teacherId;
    }
    
    // Students create submissions. Teachers review them.
    match /submissions/{submissionId} {
      allow read: if request.auth.uid == resource.data.teacherId || request.auth.uid == resource.data.studentId;
      allow create: if request.auth.uid == request.resource.data.studentId;
      allow update: if request.auth.uid == resource.data.teacherId; // For teacher to add feedback
    }

    // Students create game sessions. Teachers can read them.
    match /game_sessions/{sessionId} {
      allow read: if request.auth.uid == resource.data.studentId || request.auth.uid == resource.data.teacherId;
      allow create: if request.auth.uid == request.resource.data.studentId;
    }
  }
}
