rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    match /users/{userId} {
      // Allow anyone to read user profiles (needed for teacher code validation).
      allow read;

      // A user can create their own user document when signing up.
      allow create: if request.auth != null && request.auth.uid == userId;
      
      // A user can update their own user document.
      allow update: if request.auth != null && request.auth.uid == userId;
    }

    match /assessments/{assessmentId} {
      // An authenticated user can read an assessment if they are the teacher who created it,
      // or if they are one of the students assigned to it.
      allow read: if request.auth != null
                    && (resource.data.teacherId == request.auth.uid
                        || request.auth.uid in resource.data.assignedStudentIds);

      // Only the teacher can create or update an assessment.
      allow create, update: if request.auth != null && request.resource.data.teacherId == request.auth.uid;
    }

    match /submissions/{submissionId} {
      // A student can create a submission.
      allow create: if request.auth != null && request.resource.data.studentId == request.auth.uid;

      // A submission can be read or updated by the student who submitted it, or the teacher it was submitted to.
      allow read, update: if request.auth != null 
                           && (resource.data.studentId == request.auth.uid
                               || resource.data.teacherId == request.auth.uid);
    }
  }
}
