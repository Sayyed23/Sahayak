rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // The `users` collection stores data for both teachers and students.
    match /users/{userId} {
      
      // Allow unauthenticated users to QUERY the collection.
      // This is essential for validating a teacher's code during student sign-up.
      // It does NOT allow reading arbitrary user documents directly via a 'get' request.
      allow list: if true;

      // Allow users to read their own document once authenticated.
      allow get: if request.auth.uid == userId;

      // Allow users to create their own document upon sign-up.
      allow create: if request.auth.uid == userId;

      // Allow users to update their own document.
      allow update: if request.auth.uid == userId;
      
      // Deleting users should be handled with care, disabling direct client deletion.
      allow delete: if false;
    }
    
    // Assessments are created by teachers and read by assigned students.
    match /assessments/{assessmentId} {
      // The creating teacher or an assigned student can read the assessment.
      allow read: if request.auth.uid == resource.data.teacherId 
                  || request.auth.uid in resource.data.assignedStudentIds;
      
      // Only the teacher who created the assessment can write to it.
      allow write: if request.auth.uid == resource.data.teacherId;
    }

    // Submissions are created by students and reviewed by teachers.
    match /submissions/{submissionId} {
      // Students can create their own submissions.
      allow create: if request.auth.uid == request.resource.data.studentId;
      
      // The student who submitted it and their teacher can read it.
      allow read: if request.auth.uid == resource.data.studentId 
                  || request.auth.uid == resource.data.teacherId;
                  
      // Only the teacher can update the submission (e.g., with feedback and status).
      allow update: if request.auth.uid == resource.data.teacherId;
      
      // Prevent deletion for record-keeping.
      allow delete: if false;
    }
  }
}
